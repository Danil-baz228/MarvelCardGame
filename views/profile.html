<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é</title>
    <link rel="stylesheet" href="/profile.css">
</head>
<body>

<form class="profile-edit fade-in" id="profileForm" enctype="multipart/form-data">
    <input type="hidden" name="current_avatar_url" value="{{avatar_url}}">

    <div class="profile-avatar-block">
        <img id="avatarPreview" src="{{avatar_url}}" onerror="this.onerror=null;this.src='/uploads/avatars/images.jpg'" alt="–ê–≤–∞—Ç–∞—Ä">
        <button type="button" class="avatar-btn" onclick="document.getElementById('avatar').click()">üîÑ –ó–º—ñ–Ω–∏—Ç–∏ –∞–≤–∞—Ç–∞—Ä</button>
        <input type="file" name="avatar" id="avatar" class="avatar-file" accept="image/*">
    </div>
    <div class="profile-form">
        <div class="form-row">
            <label for="username">üë§ –Ü–º‚Äô—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞</label>
            <input type="text" id="username" name="username" value="{{username}}" required readonly>
            <a href="#" class="edit-link" onclick="enableEdit('username', event)">üîß –ó–º—ñ–Ω–∏—Ç–∏ –ª–æ–≥—ñ–Ω</a>
        </div>

        <div class="form-row">
            <label for="email">üìß Email</label>
            <input type="email" id="email" name="email" value="{{email}}" required readonly>
            <a href="#" class="edit-link" onclick="enableEdit('email', event)">üîß –ó–º—ñ–Ω–∏—Ç–∏ email</a>
        </div>



        <div class="form-row">
            <label for="password-current">üîí –ó–º—ñ–Ω–∏—Ç–∏ –ø–∞—Ä–æ–ª—å</label>
            <input type="password" id="password-current" name="password_current" placeholder="–ü–æ—Ç–æ—á–Ω–∏–π –ø–∞—Ä–æ–ª—å">
            <input type="password" id="password-new" name="password_new" placeholder="–ù–æ–≤–∏–π –ø–∞—Ä–æ–ª—å">
        </div>

        <button type="submit">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏</button>
        <div class="back-link">
            <a href="/">‚¨Ö –ù–∞–∑–∞–¥</a>
    </div>

<!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
        <div id="error-toast" class="toast error">‚ùå –¶–µ —ñ–º‚Äô—è –≤–∂–µ –∑–∞–π–Ω—è—Ç–µ</div>
        <div id="success-toast" class="toast success">‚úÖ –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∑–±–µ—Ä–µ–∂–µ–Ω–æ!</div>
        <div id="toast-wrong-password" class="toast error">‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π –ø–æ—Ç–æ—á–Ω–∏–π –ø–∞—Ä–æ–ª—å</div>
        <div id="toast-password-too-short" class="toast error">‚ùå –ù–æ–≤–∏–π –ø–∞—Ä–æ–ª—å –Ω–∞–¥—Ç–æ –∫–æ—Ä–æ—Ç–∫–∏–π (–º—ñ–Ω—ñ–º—É–º 6 —Å–∏–º–≤–æ–ª—ñ–≤)</div>
        <div id="toast-same-password" class="toast error">‚ùå –ù–æ–≤–∏–π –ø–∞—Ä–æ–ª—å —Å–ø—ñ–≤–ø–∞–¥–∞—î –∑ –ø–æ—Ç–æ—á–Ω–∏–º</div>


        <script>
            const form = document.getElementById('profileForm');
            const avatarInput = document.getElementById('avatar');
            const preview = document.getElementById('avatarPreview');

            if (avatarInput && preview) {
                avatarInput.addEventListener('change', function () {
                    const file = this.files[0];
                    if (file && file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            preview.src = e.target.result;
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }

            const showToast = (id) => {
                const toast = document.getElementById(id);
                if (!toast) return;
                toast.classList.add("show");
                setTimeout(() => {
                    toast.classList.remove("show");
                }, 3000);
            };

            form.addEventListener('submit', async (e) => {
                e.preventDefault();

                const formData = new FormData(form);

                try {
                    const res = await fetch('/profile', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await res.json();

                    if (result.success) {
                        showToast("success-toast");
                    } else {
                        switch (result.error) {
                            case "duplicate_username":
                                showToast("error-toast");
                                break;
                            case "wrong_password":
                                showToast("toast-wrong-password");
                                break;
                            case "password_too_short":
                                showToast("toast-password-too-short");
                                break;
                            case "same_password":
                                showToast("toast-same-password");
                                break;
                            default:
                                showToast("error-toast");
                        }
                    }

                } catch (err) {
                    console.error("–ü–æ–º–∏–ª–∫–∞:", err);
                    showToast("error-toast");
                }
            });

            function enableEdit(fieldId, event) {
                event.preventDefault();
                const input = document.getElementById(fieldId);
                if (input && input.hasAttribute('readonly')) {
                    input.removeAttribute('readonly');
                    input.focus();
                }
            }
        </script>


</body>
</html>
